# PeerLab BIRD Configuration
# This configuration connects to ixpfra01 via Tailscale

router id 10.0.0.1;

log syslog all;
debug protocols all;

protocol device {
    scan time 5;
}

protocol direct {
    ipv6;
}

protocol kernel {
    learn;
    ipv6 {
        import all;
        export all;
    };
}

# Static routes for user prefixes
# protocol static user_routes {
#     ipv6;
#     include "/etc/bird/prefixes.conf";
# }

# Import filter - accept everything from IXP
filter ImportFromIXP {
    # Log what we receive
    print "Received route: ", net, " from AS", bgp_path.first, " via ", from;
    accept;
}

# Export filter - only announce user prefixes
filter ExportToIXP {
    # Only export routes from user_routes protocol
    # if source = RTS_STATIC then {
    #     print "Announcing route: ", net, " to IXP";
    #     accept;
    # }
    reject;
}

# BGP session to ixpfra01
# BGP session runs over IPv4 (Tailscale), but exchanges IPv6 routes
# Note: Replace TAILSCALE_IP_OF_IXPFRA01 with the actual Tailscale IP
# You can find it by running: tailscale status | grep ixpfra01
protocol bgp ixpfra01 {
    local 100.71.126.58 as 64512;  # Your Tailscale IPv4 and ASN
    neighbor 100.102.32.36 as 215011;  # ixpfra01's Tailscale IPv4
    
    # Use multihop since Tailscale IPs aren't directly connected
    multihop;
    
    # IPv4 channel - only for BGP session establishment, no routes exchanged
    ipv4 {
        import none;
        export none;
        extended next hop on;
    };

    # IPv6 channel - exchange IPv6 routes over the IPv4 BGP session
    ipv6 {
        import filter ImportFromIXP;
        export filter ExportToIXP;
        extended next hop on;
    };

    # Connection settings
    hold time 90;
    keepalive time 30;
}
