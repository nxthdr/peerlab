# PeerLab BIRD Configuration
# Auto-generated from template - DO NOT EDIT MANUALLY
# Generated on: {{ generation_time }}

router id 10.0.0.1;

log syslog all;
debug protocols all;

protocol device {
    scan time 5;
}

protocol direct {
    ipv6;
}

protocol kernel {
    learn;
    ipv6 {
        import all;
        export all;
    };
}

# Import filter - accept everything from IXP
filter ImportFromIXP {
    accept;
}

# Export filter - reject everything
filter ExportToIXP {
    reject;
}

{% for ixp in ixp_servers %}
# BGP session to {{ ixp.name }}
# Tailscale IP: {{ ixp.ip }}
# ASN: {{ ixp.asn }}
protocol bgp {{ ixp.name }} {
    local {{ local_ip }} as {{ local_asn }};
    neighbor {{ ixp.ip }} as {{ ixp.asn }};

    # Use multihop since Tailscale IPs aren't directly connected
    multihop;

    # IPv4 channel - only for BGP session establishment, no routes exchanged
    ipv4 {
        import none;
        export none;
        extended next hop on;
    };

    # IPv6 channel - exchange IPv6 routes over the IPv4 BGP session
    ipv6 {
        import filter ImportFromIXP;
        export filter ExportToIXP;
        extended next hop on;
    };

    # Connection settings
    hold time 90;
    keepalive time 30;
}

{% endfor %}
