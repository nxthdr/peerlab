# PeerLab BIRD Configuration
# Auto-generated from template - DO NOT EDIT MANUALLY
# Generated on: {{ generation_time }}

router id 10.0.0.1;

log syslog all;
debug protocols all;

protocol device {
    scan time 5;
}

protocol direct {
    ipv6;
}

protocol kernel {
    learn;
    ipv6 {
        import all;
        export all;
    };
}

# Static routes for user prefixes
# protocol static user_routes {
#     ipv6;
#     include "/etc/bird/prefixes.conf";
# }

# Import filter - accept everything from IXP
filter ImportFromIXP {
    # Log what we receive
    print "Received route: ", net, " from AS", bgp_path.first, " via ", from;
    accept;
}

# Export filter - only announce user prefixes
filter ExportToIXP {
    # Only export routes from user_routes protocol
    # if source = RTS_STATIC then {
    #     print "Announcing route: ", net, " to IXP";
    #     accept;
    # }
    reject;
}

{% for ixp in ixp_servers %}
# BGP session to {{ ixp.name }}
# Tailscale IP: {{ ixp.ip }}
# ASN: {{ ixp.asn }}
protocol bgp {{ ixp.name }} {
    local {{ local_ip }} as {{ local_asn }};
    neighbor {{ ixp.ip }} as {{ ixp.asn }};
    
    # Use multihop since Tailscale IPs aren't directly connected
    multihop;
    
    # IPv4 channel - only for BGP session establishment, no routes exchanged
    ipv4 {
        import none;
        export none;
        extended next hop on;
    };

    # IPv6 channel - exchange IPv6 routes over the IPv4 BGP session
    ipv6 {
        import filter ImportFromIXP;
        export filter ExportToIXP;
        extended next hop on;
    };

    # Connection settings
    hold time 90;
    keepalive time 30;
}

{% endfor %}
